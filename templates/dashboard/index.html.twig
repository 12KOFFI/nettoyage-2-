{% extends 'base_web.html.twig' %}

{% block title %}Dashboard — Gestion des devis{% endblock %}

{% block stylesheets %}
<style>
  /* Compensate sticky header height on dashboard only */
  .page-inner { padding-top: 1.5rem !important; }
</style>
{% endblock %}

{% block body %}
<div class="container-fluid px-4">
  <div class="page-inner">

    {# ── Page Header ─────────────────────────────────────────── #}
    <div class="dashboard-page-header">
      <div>
        <h1 class="page-title">Tableau de bord</h1>
        <p class="page-subtitle">
          <i class="fas fa-calendar-alt me-1"></i>
          {{ "now"|date('d/m/Y') }} — Suivi en temps réel des demandes de devis
        </p>
      </div>
      <a href="{{ path('app_demande_devis_liste') }}" class="btn-view-all">
        <i class="fas fa-list"></i>Voir tous les devis
      </a>
    </div>

    {# ── KPI Cards ─────────────────────────────────────────────── #}
    <div class="row g-3 mb-4">
      <div class="col-12 col-sm-6 col-xl-4">
        <div class="card kpi-card kpi-total h-100">
          <div class="card-body d-flex align-items-center gap-3 p-4">
            <div class="kpi-icon">
              <i class="fas fa-file-signature"></i>
            </div>
            <div>
              <div class="kpi-label">Total devis</div>
              <div class="kpi-value">{{ totalDevis }}</div>
              <div class="kpi-trend mt-1 opacity-75">
                <i class="fas fa-layer-group me-1"></i>Toutes les demandes
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-xl-4">
        <div class="card kpi-card kpi-waiting h-100">
          <div class="card-body d-flex align-items-center gap-3 p-4">
            <div class="kpi-icon">
              <i class="fas fa-hourglass-half"></i>
            </div>
            <div>
              <div class="kpi-label">En attente</div>
              <div class="kpi-value">{{ pendingDevis }}</div>
              <div class="kpi-trend mt-1 opacity-75">
                <i class="fas fa-exclamation-circle me-1"></i>À traiter
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-xl-4">
        <div class="card kpi-card kpi-done h-100">
          <div class="card-body d-flex align-items-center gap-3 p-4">
            <div class="kpi-icon">
              <i class="fas fa-check-circle"></i>
            </div>
            <div>
              <div class="kpi-label">Traités</div>
              <div class="kpi-value">{{ processedDevis }}</div>
              <div class="kpi-trend mt-1 opacity-75">
                <i class="fas fa-check me-1"></i>Demandes clôturées
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {# ── Graphique + Tableau ───────────────────────────────────── #}
    <div class="row g-4 mb-4">

      {# Donut Chart #}
      <div class="col-12 col-lg-5">
        <div class="card chart-card h-100">
          <div class="card-body p-4">
            <p class="section-title mb-3">
              <i class="fas fa-chart-pie me-2 text-primary"></i>Répartition des devis
            </p>
            {% if totalDevis > 0 %}
              <div style="max-width:260px; margin:0 auto;">
                <canvas id="devisDonut"></canvas>
              </div>
              <hr class="my-3">
              <div class="px-2">
                <div class="chart-legend-item">
                  <span class="chart-legend-dot" style="background:#5e72e4;"></span>
                  <span class="chart-legend-label">Total devis</span>
                  <span class="chart-legend-val">{{ totalDevis }}</span>
                </div>
                <div class="chart-legend-item">
                  <span class="chart-legend-dot" style="background:#f5a623;"></span>
                  <span class="chart-legend-label">En attente</span>
                  <span class="chart-legend-val">{{ pendingDevis }}</span>
                </div>
                <div class="chart-legend-item">
                  <span class="chart-legend-dot" style="background:#2dce89;"></span>
                  <span class="chart-legend-label">Traités</span>
                  <span class="chart-legend-val">{{ processedDevis }}</span>
                </div>
              </div>
            {% else %}
              <div class="text-center text-muted py-5">
                <i class="fas fa-inbox fa-3x mb-3 d-block opacity-25"></i>
                Aucune donnée à afficher
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      {# Latest devis table #}
      <div class="col-12 col-lg-7">
        <div class="card chart-card h-100">
          <div class="card-body p-4">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <p class="section-title mb-0">
                <i class="fas fa-clock me-2 text-warning"></i>Dernières demandes
              </p>
              <a href="{{ path('app_demande_devis_liste') }}" class="btn btn-link btn-sm p-0 text-primary">
                Voir tout <i class="fas fa-arrow-right ms-1"></i>
              </a>
            </div>
            <div class="table-responsive">
              <table class="table table-hover table-recent mb-0">
                <thead>
                  <tr>
                    <th>Client</th>
                    <th>Local / Ville</th>
                    <th>Date</th>
                    <th class="text-end">Statut</th>
                  </tr>
                </thead>
                <tbody>
                  {% for devi in latestDevis %}
                    <tr>
                      <td>
                        <div class="fw-semibold">
                          {{ devi.client ? devi.client.nom ~ ' ' ~ devi.client.prenom : '—' }}
                        </div>
                        {% if devi.client and devi.client.email %}
                          <small class="text-muted">{{ devi.client.email }}</small>
                        {% endif %}
                      </td>
                      <td>
                        {% if devi.local %}
                          <span class="fw-semibold">{{ devi.local.typeLocal }}</span>
                          <br><small class="text-muted">{{ devi.local.ville }}</small>
                        {% else %}
                          <span class="text-muted">—</span>
                        {% endif %}
                      </td>
                      <td>
                        {{ devi.dateDemande ? devi.dateDemande|date('d/m/Y') : '—' }}
                      </td>
                      <td class="text-end">
                        {% if devi.statut == 'en_attente' %}
                          <span class="badge-status badge-en-attente">
                            <i class="fas fa-hourglass-half me-1"></i>En attente
                          </span>
                        {% elseif devi.statut == 'traite' %}
                          <span class="badge-status badge-traite">
                            <i class="fas fa-check me-1"></i>Traité
                          </span>
                        {% else %}
                          <span class="badge-status" style="background:#e2e3e5;color:#383d41;">{{ devi.statut }}</span>
                        {% endif %}
                      </td>
                    </tr>
                  {% else %}
                    <tr>
                      <td colspan="4" class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-2x d-block opacity-25 mb-2"></i>
                        Aucune demande pour le moment
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>{# /row #}

  </div>{# /page-inner #}
</div>{# /container-fluid #}
{% endblock %}

{% block javascripts %}
{% if totalDevis > 0 %}
<script>
  (function () {
    var ctx = document.getElementById('devisDonut');
    if (!ctx) return;

    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['En attente', 'Traités'],
        datasets: [{
          data: [{{ pendingDevis }}, {{ processedDevis }}],
          backgroundColor: ['#f5a623', '#2dce89'],
          borderColor:     ['#fff',    '#fff'],
          borderWidth: 3,
          hoverOffset: 8
        }]
      },
      options: {
        responsive: true,
        cutout: '72%',
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(ctx) {
                var total = {{ totalDevis }};
                var val   = ctx.parsed;
                var pct   = total > 0 ? Math.round(val / total * 100) : 0;
                return ' ' + ctx.label + ' : ' + val + ' (' + pct + '%)';
              }
            }
          }
        }
      }
    });
  })();
</script>
{% endif %}
{% endblock %}

